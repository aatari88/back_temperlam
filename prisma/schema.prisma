generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  PRODUCTION_MANAGER
  OPERATOR
  INVENTORY_CLERK
  BILLING_VIEWER // Preparado para el futuro

  @@map("user_role")
}

enum OrderStatus {
  PENDING       // Creada, no iniciada
  IN_PROGRESS   // Hay piezas moviéndose en planta
  COMPLETED     // Todas las piezas terminaron OK
  CANCELED      // Se canceló toda la orden

  @@map("order_status")
}

enum PriorityLevel {
  LOW
  NORMAL
  HIGH

  @@map("priority_level")
}

model User {
  id           String     @id @default(uuid()) @map("id")
  username     String     @unique @map("username")
  email        String?    @unique @map("email")
  password     String     @map("password")
  fullName     String     @map("full_name")
  isActive     Boolean    @default(true) @map("is_active")
  roles        UserRole[] @map("roles")
  refreshToken String?    @map("refresh_token")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @map("updated_at")

  @@map("user")
}

model WorkStation {
  id             Int      @id @default(autoincrement())
  name           String
  code           String   @unique
  description    String?
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @map("updated_at")
  
  steps          RouteStep[]
  wipItems       OrderLocation[]

  @@map("work_stations")
}

model ProductionRoute {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @map("updated_at")
 
  steps       RouteStep[]
  orders      ProductionOrder[]

  @@map("production_routes")
}

model RouteStep {
  id                Int              @id @default(autoincrement())
  routeId           Int              @map("route_id")
  route             ProductionRoute  @relation(fields: [routeId], references: [id])

  stepOrder         Int              @map("step_order")
  name              String

  requiredStationId Int             @map("required_station_id")
  requiredStation   WorkStation     @relation(fields: [requiredStationId], references: [id])
  
  @@unique([routeId, stepOrder])
  @@map("route_steps")
}

model ProductionOrder {
  id                Int      @id @default(autoincrement())
  productionCode    String   @unique @map("production_code") // Código único para rastreo

  // Datos del Cliente/Producto
  clientId          Int      @map("client_id")
  client            Client   @relation(fields: [clientId], references: [id])
  productId         Int      @map("product_id")
  product           Product  @relation(fields: [productId], references: [id])

  routeId           Int      @map("route_id")
  route             ProductionRoute @relation(fields: [routeId], references: [id])

  quantityTotal     Int      @map("quantity_total")
  quantityCompleted Int      @map("quantity_completed")
  quantityScrapped  Int      @map("quantity_scrapped")

  status            OrderStatus @default(PENDING)
  priority          PriorityLevel @default(NORMAL)

  locations         OrderLocation[]

  logs              ProductionLog[]
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @map("updated_at")

  @@index([productionCode])
  @@map("production_orders")
}

model OrderLocation {
  id              Int      @id @default(autoincrement())
  orderId         Int      @map("order_id")
  order           ProductionOrder @relation(fields: [orderId], references: [id])

  stationId       Int      @map("station_id")
  station         WorkStation @relation(fields: [stationId], references: [id])

  stepOrder       Int      @map("step_order")

  quantity        Int

  updatedAt       DateTime @updatedAt

  @@unique([orderId, stationId, stepOrder])
  @@map("order_locations")
}

model ProductionLog {
  id          Int      @id @default(autoincrement())
  orderId     Int      @map("order_id")
  order       ProductionOrder @relation(fields: [orderId], references: [id])

  stationId   Int?     @map("station_id")
  operatorId  String?  @map("operator_id")

  action      String   // STARTED, MOVED, COMPLETED, SCRAP_REPORT
  quantity    Int
  details     String?

  createdAt   DateTime @default(now())

  @@map("production_logs")
}

model Client {
  id          Int      @id @default(autoincrement())
  name        String
  contactInfo String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @map("updated_at")

  orders       ProductionOrder[]

  @@map("clients")
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @map("updated_at")

  orders       ProductionOrder[]

  @@map("products")
}